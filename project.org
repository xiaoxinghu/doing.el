#+title: doing.el
#+todo: IDEA TODO | DONE KILLED

For new feature/task to be marked as =DONE=, make sure that:
- all existing tests passes
- new tests are added for guarding the new feature, and passing
  - design tests with purpose, only test things that tend to remain unchanged in a long term, e.g. the interface (interactive functions), and concrete logic about the fundamental functionality of the app.
  - add necessary tests that can help verify the intended behaviours
- try to leverage existing functions as much as possible. before implementing any code ourselves, think whether the required functionality is general enough, or "org-mode enough", if so, search for existing solutions before reinventing the wheels ourselves.

* Built-in Functions Reference

This section documents Emacs and Org-mode built-in functions we leverage.
*Do not reinvent the wheel* — use these wherever possible.

** Org-Element API (Parsing)

rource: [[https://orgmode.org/worg/dev/org-element-api.html][Org Element API]]

| Function                    | Purpose                                         |
|-----------------------------+-------------------------------------------------|
| =org-element-parse-buffer=    | Parse entire buffer into AST                    |
| =org-element-at-point=        | Parse element at cursor position                |
| =org-element-map=             | Traverse AST, collect/filter elements           |
| =org-element-property=        | Get property from parsed element                |
| =org-element-type=            | Get element type (headline, paragraph, etc.)    |
| =org-element-contents=        | Get child elements                              |
| =org-element-interpret-data=  | Convert AST back to Org syntax                  |
| =org-element-headline-parser= | Parse a headline (returns plist with all props) |

*** Headline properties available via =org-element-property=

- =:raw-value= — headline text without tags
- =:title= — parsed title
- =:level= — headline level (1, 2, 3...)
- =:tags= — list of tags
- =:todo-keyword= — TODO state
- =:priority= — priority character
- =:begin=, =:end= — buffer positions
- =:contents-begin=, =:contents-end= — body positions
- =:PROPERTY-NAME= — any property from drawer (uppercase with colon)

** Org Property API

| Function                   | Purpose                            |
|----------------------------+------------------------------------|
| =org-entry-get=              | Get property value at point/marker |
| =org-entry-put=              | Set property value                 |
| =org-entry-delete=           | Delete a property                  |
| =org-entry-properties=       | Get all properties as alist        |
| =org-insert-property-drawer= | Insert empty property drawer       |

** Org Duration API (=org-duration.el=)

| Function                  | Purpose                                |
|---------------------------+----------------------------------------|
| =org-duration-to-minutes=   | Convert "1:30" or "1h 30m" to 90.0     |
| =org-duration-from-minutes= | Convert 90 to "1:30" (respects format) |
| =org-duration-p=            | Check if string is valid duration      |

** Org Timestamp & Date

| Function              | Purpose                               |
|-----------------------+---------------------------------------|
| =org-read-date=         | Interactive date prompt with calendar |
| =org-time-stamp-format= | Get timestamp format string           |
| =org-parse-time-string= | Parse Org timestamp to time list      |

** Emacs Time Functions

| Function           | Purpose                                        |
|--------------------+------------------------------------------------|
| =format-time-string= | Format time (=%Y-%m-%d=, =%V= for ISO week)        |
| =decode-time=        | Time to (SEC MIN HOUR DAY MON YEAR DOW DST TZ) |
| =encode-time=        | (SEC MIN...) to time value                     |
| =time-subtract=      | Difference between two times                   |
| =float-time=         | Time value to seconds as float                 |
| =parse-time-string=  | Parse RFC 822 / ISO 8601 string                |
| =format-seconds=     | Format duration: =%h:%.2m:%.2s=                  |

*** ISO Week Number

#+BEGIN_SRC elisp
;; Get ISO week number
(format-time-string "%G-W%V")  ; => "2026-W04"
(format-time-string "%V")      ; => "04"
#+END_SRC

** Org-QL (Optional Dependency)

Source: [[https://github.com/alphapapa/org-ql][github.com/alphapapa/org-ql]]

If =org-ql= is available, use it for advanced querying instead of custom code.

| Function      | Purpose                                     |
|---------------+---------------------------------------------|
| =org-ql-select= | Query files, return list of elements        |
| =org-ql-search= | Interactive search with agenda-like display |

*** Query predicates

- =heading=, =regexp=, =tags=, =property=
- =ts=, =ts-active=, =ts-inactive= (timestamp queries)
- =scheduled=, =deadline=, =closed=

*** Example

#+BEGIN_SRC elisp
;; Find all entries with tag "emacs" from this week
(org-ql-select (doing--file-today)
  '(and (tags "emacs")
        (ts :from -7)))
#+END_SRC
