#+title: doing.el Development Progress

* 2026-01-23 - Package skeleton and configuration
- what was implemented
  - Main package file (doing.el) with proper headers
  - Package metadata: author, version, dependencies (emacs 27.1, org 9.0)
  - Customization group =doing= under =org= group
  - User-facing customization: =doing-directory= (default ~/org/doing/)
  - Internal configuration constants for file names (today.org, week.org, archive/)
- files changed
  - doing.el — complete rewrite with proper package structure
  - tests/doing-test.el — new tests for customization group and config
- learnings
  - patterns discovered
    - Use =defconst= for internal configuration that shouldn't change
    - Keep internal config separate from user customization (=defcustom= vs =defconst=)
    - Testing for customization group via =(get 'symbol 'custom-group)=
  - gotchas encountered
    - Need to use =expand-file-name= in default value for =doing-directory= to ensure absolute path
    - Package-Requires uses parenthesized list format: =((emacs "27.1") (org "9.0"))=

* 2026-01-23 - File and directory utilities
- what was implemented
  - Created doing-lib.el with core file/directory utilities
  - =doing--directory ()= — creates and returns the doing directory with archive subdirectory
  - =doing--file-today ()= — returns full path to today.org
  - =doing--file-week ()= — returns full path to week.org
  - =doing--file-archive (year week)= — returns path to archive/YYYY-WNN.org with zero-padded week numbers
  - =doing--ensure-directory ()= — ensures directory structure exists
  - =doing--ensure-file (path &optional title)= — creates file with Org header if missing
  - Added comprehensive tests covering all utilities
  - Updated doing.el and doing-test.el to require doing-lib
- files changed
  - doing-lib.el — new file with internal utilities (double-hyphen prefix for internal functions)
  - tests/doing-test.el — added 4 new tests for file/directory operations
  - doing.el — added =(require 'doing-lib)=
- learnings
  - patterns discovered
    - Using =make-directory= with =t= argument creates parent directories automatically
    - Combining =file-name-sans-extension= and =file-name-nondirectory= to derive titles from filenames
    - =doing--directory= creates both main and archive dirs in one call for convenience
    - Testing with temporary directories using =make-temp-file= with =t= flag and =unwind-protect= for cleanup
    - =write-region= is the standard way to create new files from a temp buffer
  - gotchas encountered
    - Archive file path format uses =%04d= and =%02d= to ensure proper zero-padding (2026-W01, not 2026-W1)
    - =doing--ensure-directory= is a thin wrapper that just calls =doing--directory= since that already creates directories
    - Must call =expand-file-name= in all path functions to ensure absolute paths
    - Tests need to verify both file existence AND that files are directories with =file-directory-p=

* 2026-01-23 - Timestamp and duration utilities
- what was implemented
  - Added timestamp and duration utilities to doing-lib.el
  - =doing--timestamp-now ()= — returns current time as Org inactive timestamp [YYYY-MM-DD DDD HH:MM]
  - =doing--timestamp-to-time (timestamp)= — parses Org timestamp string to Emacs time structure
  - =doing--timestamp-date (timestamp)= — extracts YYYY-MM-DD from timestamp string
  - =doing--duration-minutes (start-ts end-ts)= — computes elapsed minutes between two timestamps
  - =doing--duration-format (minutes)= — formats minutes as H:MM string using =org-duration-from-minutes=
  - =doing--iso-week (&optional time)= — returns (YEAR WEEK) list for given time or now
  - =doing--iso-week-string (&optional time)= — returns YYYY-WNN string for archive file naming
  - Added 7 comprehensive tests covering all timestamp/duration functionality
  - All 15 tests pass successfully
- files changed
  - doing-lib.el — added timestamp and duration utility functions
  - tests/doing-test.el — added 7 new tests (doing-test-timestamp-now-format, doing-test-timestamp-date-extraction, doing-test-duration-calculation, doing-test-duration-format, doing-test-iso-week-string, doing-test-iso-week, doing-test-timestamp-to-time)
- learnings
  - patterns discovered
    - =format-time-string= with =%G= gives ISO year, =%V= gives ISO week number (zero-padded)
    - =org-parse-time-string= converts Org timestamps to decoded time lists (9 elements)
    - =encode-time= converts decoded time back to internal time representation
    - =time-subtract= and =float-time= are used together to compute elapsed seconds
    - =org-duration-from-minutes= handles duration formatting automatically, respecting =org-duration-format=
    - ISO 8601 week numbers can differ from calendar year (e.g., early January might be week 52/53 of previous year)
    - Using =encode-time= in tests with explicit values (sec min hour day month year) creates reproducible test fixtures
  - gotchas encountered
    - Org inactive timestamps use brackets =[...]= not angle brackets =<...>=
    - =org-parse-time-string= returns a 9-element list: (SEC MIN HOUR DAY MON YEAR DOW DST TZ)
    - ISO week calculation requires =%G= (ISO year) not =%Y= (calendar year) to handle year boundaries correctly
    - =time-subtract= expects both arguments to be time values (not decoded time), so must call =encode-time= first
    - Duration formatting behavior depends on =org-duration-format= customization, so tests check for presence of digits rather than exact format
    - Week numbers are 1-indexed and can go up to 53 in some years (ISO 8601 long years)

* 2026-01-23 - Entry parsing with org-element
- what was implemented
  - Added entry parsing utilities to doing-lib.el using org-element API
  - =doing--parse-entry-at-point ()= — parses headline at point into entry plist with :id, :title, :tags, :started, :ended, :project, :begin, :end
  - =doing--parse-buffer ()= — returns list of all entries in current buffer by parsing with org-element-parse-buffer
  - =doing--parse-file (path)= — returns list of entries from file at PATH, using temp buffer to avoid interfering with user's buffers
  - Added 3 comprehensive tests covering single entry parsing, multiple entry parsing, and file parsing
  - All 18 tests pass successfully (15 from previous phases + 3 new tests)
- files changed
  - doing-lib.el — added entry parsing section with three parsing functions
  - tests/doing-test.el — added 3 new tests (doing-test-parse-entry-at-point, doing-test-parse-buffer-multiple, doing-test-parse-file)
- learnings
  - patterns discovered
    - =org-element-at-point= returns parsed element at cursor position; check type with =org-element-type=
    - =org-element-parse-buffer= with ='headline= granularity is fast and efficient for parsing entire buffers
    - =org-element-map= with lambda function is the idiomatic way to traverse and extract data from parsed AST
    - Properties from drawer are available via =org-element-property= with uppercase keyword symbols (e.g., =:ID=, =:STARTED=, =:PROJECT=)
    - =:raw-value= property contains the headline text without tags
    - =:tags= property returns a list of tag strings, or nil if no tags
    - =:begin= and =:end= properties give buffer positions for the entry
    - Using =with-temp-buffer= + =insert-file-contents= + =org-mode= is the pattern for parsing files without side effects
    - Test files need proper Org structure with #+TITLE and blank lines between entries
  - gotchas encountered
    - Must call =org-mode= in temp buffer after inserting file contents, otherwise org-element functions won't work properly
    - =org-element-at-point= returns nil (not an error) when point is not at a headline, so must check with =when=
    - Property values are stored as strings in the element plist, including timestamps
    - Tags are returned as a list, not a string, and empty tag lists are nil (not empty list)
    - =find-file-noselect= opens buffers which remain open after tests, while =with-temp-buffer= cleans up automatically
    - Tests creating multiple test files in same temp directory need unique filenames to avoid conflicts

* 2026-01-23 - Entry serialization — plist to Org
- what was implemented
  - Added entry serialization utilities to doing-lib.el
  - =doing--entry-to-org (entry)= — converts entry plist to Org headline string with properties drawer
    - Handles title, tags, id, started, ended, project, and body fields
    - Automatically computes and includes DURATION property when entry is finished (has :ended)
    - Tags are formatted as :tag1:tag2: on headline
    - Body text is appended after properties drawer
  - =doing--append-entry-to-file (entry path)= — appends formatted entry to file
    - Creates file with Org header if it doesn't exist (uses doing--ensure-file)
    - Uses temp buffer and append-to-file for safe appending
  - Added 7 comprehensive tests covering all serialization scenarios
  - All 25 tests pass successfully (18 from previous phases + 7 new tests)
- files changed
  - doing-lib.el — added Entry Serialization Utilities section with doing--entry-to-org and doing--append-entry-to-file
  - tests/doing-test.el — added Phase 5 with 7 new tests (doing-test-entry-to-org-minimal, doing-test-entry-to-org-with-tags, doing-test-entry-to-org-finished, doing-test-entry-to-org-with-project, doing-test-entry-to-org-with-body, doing-test-append-entry-to-file, doing-test-entry-to-org-complete)
- learnings
  - patterns discovered
    - Using =concat= with =when= conditionals to build up Org text incrementally makes code readable
    - =mapconcat #'identity tags ":"= is the idiomatic way to join tag lists into Org tag format :tag1:tag2:
    - =append-to-file= safely appends content to existing files without reading entire file into memory
    - Duration calculation is embedded in serialization: when an entry has :ended, compute duration on the fly using doing--duration-minutes and doing--duration-format
    - Property drawer format requires specific spacing: ":PROPERTY:  value" with multiple spaces for alignment
    - Body text should be appended after :END: with a newline to separate it from properties
    - Testing serialization requires checking for pattern matches (string-match-p) rather than exact strings, since duration formatting can vary
  - gotchas encountered
    - Must use =when= to conditionally include optional properties (ended, project, body) or empty plists will generate "nil" strings
    - Tags list can be nil (no tags) or a list of strings - must check with =when tags= before formatting
    - Duration is computed from start/end timestamps every time entry is serialized, not stored in the plist (it's derived data)
    - =append-to-file= requires temp buffer pattern: insert into temp buffer first, then append (point-min) (point-max) to file
    - File must exist before appending, so always call =doing--ensure-file= first to handle the case of new files
    - Format string alignment in properties drawer uses multiple spaces (":ID:       value") for visual consistency, matching Org-mode conventions
    - Body text should include trailing newline when present to ensure proper spacing between entries

* 2026-01-23 - Entry modification using org-entry API
- what was implemented
  - Added entry modification utilities to doing-lib.el for editing and deleting entries
  - =doing--goto-entry (id &optional file)= — navigates to entry by ID within a buffer
    - Searches for =:ID:= property using regex to handle whitespace variations
    - Uses =org-back-to-heading= to position point at headline start
    - Returns point if found, nil otherwise
  - =doing--update-entry-property (id property value &optional file)= — updates entry properties
    - Uses =org-entry-put= to modify properties without manual text manipulation
    - Automatically saves buffer after update
    - Returns t on success, nil if entry not found
  - =doing--delete-entry (id &optional file)= — removes entire entry
    - Uses =org-cut-subtree= to delete entry and all its content
    - Automatically saves buffer after deletion
    - Returns t on success, nil if entry not found
  - Added 5 comprehensive tests covering all modification scenarios
  - All 30 tests pass successfully (25 from previous phases + 5 new tests)
- files changed
  - doing-lib.el — added Entry Modification Utilities section with three new functions
  - tests/doing-test.el — added Phase 6 with 5 new tests:
    - doing-test-goto-entry — tests finding entries by ID and position handling
    - doing-test-update-property — tests property updates with org-entry-put
    - doing-test-delete-entry — tests entry deletion with org-cut-subtree
    - doing-test-goto-entry-with-whitespace — tests robustness to property drawer formatting
    - doing-test-update-property-multiple — tests updating multiple properties on same entry
- learnings
  - patterns discovered
    - =doing--goto-entry= must be called within the buffer context (uses point implicitly)
    - =org-entry-put= with =nil= as first argument operates on entry at point
    - =org-cut-subtree= removes entire subtree including body and nested headings
    - =org-back-to-heading= reliably positions point at headline start after property search
    - Using =save-excursion= in wrapper functions allows goto-entry to modify point without affecting caller
    - Regular expression =^[ \t]*:ID:[ \t]+%s[ \t]*$= handles various whitespace styles in property drawers
    - =find-file-noselect= opens file buffer without displaying it, useful for programmatic access
    - Tests should use =save-excursion= when calling functions that move point to avoid test interference
  - gotchas encountered
    - Initial implementation wrapped =doing--goto-entry= in =save-excursion=, but it needs to actually move point for =org-entry-put= and =org-cut-subtree= to work
    - =doing--goto-entry= cannot determine buffer context itself - caller must ensure correct buffer is current
    - Tests calling =doing--goto-entry= directly need to establish buffer context with =with-current-buffer=
    - Property drawer whitespace is inconsistent (tabs vs spaces), so regex must be flexible: =[ \t]+= not just spaces
    - =org-cut-subtree= shows "Cut: Subtree(s)" messages even in batch mode - this is normal org behavior
    - Must call =org-mode= on buffers created from file contents or org-element functions won't work properly
    - =org-entry-get= returns =nil= (not empty string) for missing properties, must use =(string= value ...)= in tests

* 2026-01-23 - Generate entry ID
- what was implemented
  - Added =doing--generate-id ()= function to doing-lib.el
  - Function generates timestamp-based unique IDs in format YYYYMMDDTHHMMSS
  - Returns a 15-character string using =format-time-string= with pattern "%Y%m%dT%H%M%S"
  - Added comprehensive tests for ID generation with 2 test cases
  - All 32 tests pass successfully (30 from previous phases + 2 new tests)
- files changed
  - doing-lib.el — added Entry ID Generation section with =doing--generate-id= function
  - tests/doing-test.el — added Phase 7 with 2 new tests:
    - doing-test-generate-id-format — validates ID format (15 chars, YYYYMMDDTHHMMSS pattern, reasonable values for year/month/day/hour/minute/second)
    - doing-test-generate-id-uniqueness — basic uniqueness test with sleep-for delay
- learnings
  - patterns discovered
    - =format-time-string= with "%Y%m%dT%H%M%S" produces compact timestamp-based IDs without special characters
    - Timestamp-based IDs are simple, sortable chronologically, and unique enough for single-user activity logging
    - Test can validate all components of timestamp ID by substring extraction and range checking
    - Using =sleep-for= with small delay (0.01s) in tests to ensure different timestamps for uniqueness testing
    - ID format follows ISO 8601 basic format (no dashes/colons) making it safe for property values
  - gotchas encountered
    - Uniqueness test is probabilistic - two IDs generated in same second would be identical, but acceptable for our use case
    - Test validates ID components (year, month, day, etc.) have reasonable ranges rather than exact values
    - No need for complex UUID libraries or =org-id= integration - simple timestamp is sufficient
    - Format string "%Y%m%dT%H%M%S" differs from display timestamps which use brackets and separators

* 2026-01-23 - doing-now — basic capture
- what was implemented
  - Created doing-now.el with the =doing-now= command for starting new activities
  - =doing-now= function takes a title and optional tags, creates entry in today.org
  - Entry includes auto-generated ID, title, tags (if provided), and STARTED timestamp
  - Command is interactive, prompting user for "What are you doing?"
  - Message confirms when activity is started
  - Added 3 comprehensive tests for doing-now functionality
  - All 35 tests pass successfully (32 from previous phases + 3 new tests)
  - Package compiles cleanly without warnings after adding forward declarations
- files changed
  - doing-now.el — new feature file with =doing-now= command (follows project structure guidelines)
  - doing.el — added =(require 'doing-now)= to load the new module
  - doing-lib.el — added forward declarations for variables from doing.el, added =(require 'org-element)=
  - tests/doing-test.el — added Phase 8 with 3 new tests:
    - doing-test-now-creates-entry — tests entry creation, multiple entries, ID/timestamp format validation
    - doing-test-now-without-tags — tests that command works without tags argument
    - doing-test-now-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Following CLAUDE.md guidelines for file organization: feature files named =doing-<feature>.el=
    - =doing-now.el= contains only the capture-related functionality, keeping code modular
    - Using =;;;###autoload= cookie on user-facing commands for proper autoloading
    - Interactive prompt string "sWhat are you doing? " where "s" means string input
    - =doing--ensure-directory= is called before file operations to guarantee directory exists
    - =doing--append-entry-to-file= handles both file creation and appending in one call
    - Forward declarations with =defvar= allow library files to reference variables from main package
    - =(require 'org-element)= needed in doing-lib.el to avoid compilation warnings about org-element functions
    - Test structure validates all entry components: title, tags, ID format, timestamp format, finished status
    - =(commandp 'doing-now)= is the proper way to test if function is interactive
  - gotchas encountered
    - Initial compilation showed warnings about free variables - resolved with forward declarations
    - Compilation warnings also appeared for org-element functions - resolved by adding =(require 'org-element)=
    - Must use =defvar= not =defcustom= in forward declarations or it creates duplicate definitions
    - Tests must use temporary directories to avoid interfering with user's actual doing directory
    - =doing-now= message output appears in test results ("Started: Write tests") which is expected behavior
    - File compilation order matters: doing.el must be compiled before doing-now.el since it defines the variables

* 2026-01-23 - doing-current — show current activity
- what was implemented
  - Created doing-current.el with the =doing-current= command for displaying current unfinished activity
  - =doing--current-entry= helper function finds the most recent unfinished entry from today.org
  - =doing-current= command displays current activity with elapsed time in minibuffer
  - Command is interactive, showing elapsed time in format [H:MM] followed by activity title
  - Handles case when no activity is in progress with appropriate message
  - Added 4 comprehensive tests for doing-current functionality
  - All 39 tests pass successfully (35 from previous phases + 4 new tests)
  - Package compiles cleanly without warnings
- files changed
  - doing-current.el — new feature file with =doing-current= and =doing--current-entry= (follows project structure guidelines)
  - doing.el — added =(require 'doing-current)= to load the new module
  - tests/doing-test.el — added Phase 9 with 4 new tests:
    - doing-test-current-shows-active — tests display of active entry with elapsed time, multiple entries
    - doing-test-current-when-nothing-active — tests "No activity in progress" message
    - doing-test-current-entry-helper — tests internal helper function behavior with various entry states
    - doing-test-current-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Using =seq-find= with =reverse= to get most recent entry first is elegant and readable
    - Testing message output requires capturing from *Messages* buffer with =point-max= positioning
    - =if-let= provides clean conditional binding for nil-safe entry access
    - Helper function =doing--current-entry= provides good separation between logic and presentation
    - Computing elapsed time for current (unfinished) activity uses current time as end timestamp
    - Multiple tests for same feature can validate different aspects: display, error handling, helper functions
    - Following established pattern: feature file named =doing-current.el=, helper functions use =doing--= prefix
  - gotchas encountered
    - Message buffer testing is tricky - must get =point-max= before calling function and read after
    - =if-let= requires entry to be non-nil; when nil, falls through to else clause correctly
    - =doing--current-entry= intentionally returns nil when no unfinished entries exist, not an error
    - =reverse= is necessary because =doing--parse-file= returns entries in file order (oldest first)
    - Tests create finished entries by manually setting :ended property, simulating real workflow
    - Message output appears in test results which is expected and not a problem

* 2026-01-23 - doing-finish — finish current activity
- what was implemented
  - Created doing-finish.el with the =doing-finish= command for completing current activity
  - Command sets ENDED property to current timestamp and computes DURATION
  - Uses existing =doing--current-entry= helper from doing-current.el to find unfinished entry
  - Leverages =doing--update-entry-property= to set both ENDED and DURATION properties
  - Displays completion message showing task title and duration
  - Signals =user-error= when no activity is in progress
  - Added 7 comprehensive tests for doing-finish functionality
  - All 46 tests pass successfully (39 from previous phases + 7 new tests)
  - Package compiles cleanly without warnings
- files changed
  - doing-finish.el — new feature file with =doing-finish= command
  - doing.el — added =(require 'doing-finish)= to load the new module
  - tests/doing-test.el — added =(require 'doing-finish)= and Phase 10 with 7 new tests:
    - doing-test-finish-sets-ended — validates ENDED property is set with correct timestamp format
    - doing-test-finish-sets-duration — verifies DURATION property is computed and written to file
    - doing-test-finish-error-when-no-current — tests user-error when no activity exists
    - doing-test-finish-with-message — validates completion message contains title and duration
    - doing-test-finish-multiple-times — tests error when trying to finish again without new activity
    - doing-test-finish-preserves-other-properties — ensures tags, ID, STARTED are preserved
    - doing-test-finish-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Reusing =doing--current-entry= from doing-current.el demonstrates good code reuse between feature modules
    - =doing-finish= requires =doing-current= module since it depends on =doing--current-entry= helper
    - Multiple calls to =doing--update-entry-property= in sequence is the pattern for setting multiple properties
    - Duration is computed on-the-fly during finish operation using =doing--duration-minutes= and formatted with =doing--duration-format=
    - Message format "Finished: TITLE (DURATION)" provides user feedback with both what was done and how long it took
    - Tests use =sleep-for 0.01= or =sleep-for 0.02= to ensure measurable time differences between start and finish
    - Testing DURATION property requires reading file directly (not just parsed entry) since it's written during finish
    - Comprehensive test coverage includes: property setting, error conditions, message output, preservation of existing data
  - gotchas encountered
    - Must =(require 'doing-current)= in doing-finish.el to access =doing--current-entry= function
    - =user-error= is the appropriate error type for interactive commands when user action is needed
    - Duration test must use file content check (=insert-file-contents=) because DURATION is written as property
    - Pattern ":DURATION:.*[0-9]" used in regex to account for varying spacing in property drawer format
    - Cannot finish twice in a row - second call errors because first finish removes the "current" entry
    - Tests preserve other entry properties (tags, ID, STARTED) and validate they survive the finish operation
    - Message testing pattern established in doing-current tests applies here: capture from *Messages* buffer

* 2026-01-23 - doing-cancel — cancel current activity
- what was implemented
  - Created doing-cancel.el with the =doing-cancel= command for canceling current unfinished activity
  - Command prompts user with =yes-or-no-p= for confirmation before deletion
  - Uses existing =doing--current-entry= helper from doing-current.el to find unfinished entry
  - Leverages =doing--delete-entry= to completely remove entry using =org-cut-subtree=
  - Displays cancellation message showing task title
  - Signals =user-error= when no activity is in progress
  - Added 5 comprehensive tests for doing-cancel functionality
  - All 51 tests pass successfully (46 from previous phases + 5 new tests)
  - Package compiles cleanly without warnings
- files changed
  - doing-cancel.el — new feature file with =doing-cancel= command
  - doing.el — added =(require 'doing-cancel)= to load the new module
  - tests/doing-test.el — added =(require 'doing-cancel)= and Phase 11 with 5 new tests:
    - doing-test-cancel-removes-entry — validates entry deletion with yes-or-no-p confirmation
    - doing-test-cancel-error-when-no-current — tests user-error when no activity exists
    - doing-test-cancel-with-user-abort — tests that entry is preserved when user answers no
    - doing-test-cancel-shows-message — validates cancellation message contains title
    - doing-test-cancel-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Following established pattern: feature file named =doing-cancel.el=, follows module structure from previous features
    - Reusing =doing--current-entry= from doing-current.el demonstrates good code reuse between feature modules
    - =doing-cancel= requires =doing-current= module since it depends on =doing--current-entry= helper
    - =yes-or-no-p= is the standard Emacs function for confirmation prompts requiring full word input
    - =doing--delete-entry= with ID parameter handles complete removal including subtree content
    - Comprehensive test coverage includes: confirmation flow, error conditions, message output, user abort scenario
    - Using =cl-letf= to temporarily override =yes-or-no-p= in tests allows testing both confirmation branches
    - Testing user abort (answering no) ensures graceful handling without data loss
  - gotchas encountered
    - Must =(require 'doing-current)= in doing-cancel.el to access =doing--current-entry= function
    - =yes-or-no-p= requires user to type full "yes" or "no" (not just y/n), appropriate for destructive operations
    - =cl-letf= requires proper lambda form: =(lambda (_) t)= or =(lambda (_) nil)= to override =yes-or-no-p=
    - When user answers no to confirmation, function returns normally without error (expected behavior)
    - Tests must verify both that entry is deleted (when confirmed) and preserved (when aborted)
    - =org-cut-subtree= shows "Cut: Subtree(s)" messages in test output which is normal org behavior
    - Cancellation is destructive and irreversible - confirmation prompt is essential for user safety

* 2026-01-23 - doing-note — add notes to current activity
- what was implemented
  - Created doing-note.el with the =doing-note= command for adding notes to current unfinished activity
  - Command prompts for text and appends it to the body of the current entry
  - Uses =org-end-of-meta-data t= to position cursor after properties drawer for insertion
  - Uses =find-file-noselect= to edit file without displaying buffer
  - Leverages =doing--goto-entry= to navigate to entry by ID
  - Displays confirmation message "Note added"
  - Signals =user-error= when no activity is in progress
  - Added 5 comprehensive tests for doing-note functionality
  - All 56 tests pass successfully (51 from previous phases + 5 new tests)
  - Package compiles cleanly without warnings
- files changed
  - doing-note.el — new feature file with =doing-note= command
  - doing.el — added =(require 'doing-note)= to load the new module
  - tests/doing-test.el — added =(require 'doing-note)= and Phase 12 with 5 new tests:
    - doing-test-note-appends-text — tests note appending, multiple notes to same entry
    - doing-test-note-error-when-no-current — tests user-error when no activity exists
    - doing-test-note-after-properties — validates note position after :END: marker
    - doing-test-note-shows-message — validates confirmation message display
    - doing-test-note-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Following established pattern: feature file named =doing-note.el=, follows module structure from previous features
    - Reusing =doing--current-entry= from doing-current.el demonstrates good code reuse between feature modules
    - =doing-note= requires =doing-current= module since it depends on =doing--current-entry= helper
    - =org-end-of-meta-data t= is the standard way to position after properties drawer, moving past scheduled/deadline/planning lines
    - Using =find-file-noselect= to edit files programmatically without displaying the buffer to user
    - =save-excursion= wraps the editing operations to preserve point position in case buffer is visible
    - Text insertion followed by newline ensures proper spacing between multiple notes
    - Comprehensive test coverage includes: text appending, multiple notes, error conditions, message output, insertion position
    - Testing insertion position uses file content search with =re-search-forward= to verify ordering
  - gotchas encountered
    - Must =(require 'doing-current)= in doing-note.el to access =doing--current-entry= function
    - =org-end-of-meta-data t= with argument =t= moves past planning info (SCHEDULED, DEADLINE), not just properties drawer
    - Note text is inserted with trailing newline to ensure proper spacing between consecutive notes
    - Tests verify position by searching for :END: marker and note text, confirming note comes after properties
    - =save-buffer= is necessary to persist changes to file after insertion
    - Interactive prompt uses "sNote: " where "s" indicates string input (similar to other doing commands)
    - Message testing pattern established in previous features applies here: capture from *Messages* buffer before/after

* 2026-01-23 - doing-now enhancement — auto-finish previous activity
- what was implemented
  - Enhanced =doing-now= command to automatically finish the previous unfinished activity before starting a new one
  - Added =(require 'doing-current)= and =(require 'doing-finish)= to doing-now.el for access to helper functions
  - Modified =doing-now= to call =doing-finish= when =doing--current-entry= returns a non-nil value
  - Updated docstring to document the auto-finish behavior
  - Added comprehensive test =doing-test-now-finishes-previous= to verify auto-finish functionality
  - Test validates that first entry is finished (has :ended property) and second entry remains unfinished
  - Test also verifies DURATION property is computed and written to file
  - All 57 tests pass successfully (56 from previous phases + 1 new test)
- files changed
  - doing-now.el — added auto-finish logic and required modules (doing-current, doing-finish)
  - tests/doing-test.el — added Phase 8 test =doing-test-now-finishes-previous= with buffer cleanup
- learnings
  - patterns discovered
    - Circular workflow: starting new activity naturally finishes the old one without explicit user action
    - Using =when= with =doing--current-entry= provides clean conditional auto-finish logic
    - Module dependencies: doing-now depends on doing-current and doing-finish, establishing clear dependency chain
    - Test must kill file buffer with =kill-buffer (get-file-buffer path)= before re-parsing to ensure fresh data from disk
    - Adding =sleep-for 0.02= between operations ensures measurable time differences for duration calculations
    - Testing both parsed properties (:ended) and file content (:DURATION:) provides comprehensive validation
  - gotchas encountered
    - CRITICAL: Emacs batch mode uses byte-compiled files (.elc) when they exist, even if source is newer
    - Must run =make compile= or manually byte-compile changed files before running tests
    - Warning "Source file newer than byte-compiled file" indicates tests are using OLD code
    - Without buffer cleanup via =kill-buffer=, =doing--parse-file= may read cached buffer data instead of disk
    - =find-file-noselect= keeps buffers open, which can cause stale data issues in tests
    - Auto-finish changes behavior of existing code: =doing-test-now-creates-entry= still passes because it creates 2 entries (first is auto-finished)
    - Message output "Started:" appears but no "Finished:" means =doing-finish= wasn't called, likely due to byte-compilation issue

* 2026-01-23 - doing-again — resume last activity
- what was implemented
  - Created doing-again.el with =doing-again= command for resuming previous finished activities
  - =doing--last-finished-entry= helper function finds most recent finished entry by filtering finished entries and taking last one
  - =doing-again= command calls =doing-now= with title and tags from last finished entry
  - Creates fresh entry with new ID and timestamp when resuming
  - Signals =user-error= when no previous finished activity exists
  - Added 6 comprehensive tests covering all functionality
  - All 63 tests pass successfully (57 from previous phases + 6 new tests)
  - Package compiles cleanly without warnings
- files changed
  - doing-again.el — new feature file with =doing-again= and =doing--last-finished-entry= (follows project structure guidelines)
  - doing.el — added =(require 'doing-again)= to load the new module
  - tests/doing-test.el — added =(require 'doing-again)= and Phase 13 with 6 new tests:
    - doing-test-again-copies-title-and-tags — tests that resumed entry has same title/tags but different ID
    - doing-test-again-error-when-no-previous — tests user-error when no finished activities exist
    - doing-test-again-uses-most-recent-finished — tests with multiple finished entries, verifies most recent is resumed
    - doing-test-again-creates-fresh-timestamps — tests that IDs are unique (even if timestamps might be same minute)
    - doing-test-last-finished-entry-helper — tests internal helper with various entry states
    - doing-test-again-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Following established pattern: feature file named =doing-again.el=, requires =doing-now= since it depends on it
    - =doing--last-finished-entry= uses =seq-filter= to get finished entries, then =car= of =last= to get most recent
    - This is more reliable than =seq-find= with =reverse= which stops at first match when searching backwards
    - =doing-again= is essentially a convenient wrapper around =doing-now= with preset title and tags
    - Tests need long sleep times (1.1 seconds) to ensure distinct IDs since IDs are timestamp-based with second precision
    - Buffer management in tests: killing buffers with =kill-buffer (get-file-buffer path)= ensures fresh disk reads
    - Using =cl-letf= to suppress =yes-or-no-p= prompts in batch mode tests prevents interactive prompts during test runs
  - gotchas encountered
    - Must =(require 'doing-now)= in doing-again.el since it depends on the =doing-now= function
    - =seq-find= with =reverse= doesn't work as expected - it finds FIRST match in reversed list, not LAST in original
    - Correct approach: filter finished entries first, then take =car= of =last= to get most recent
    - Timestamp-based IDs (YYYYMMDDTHHMMSS format) can collide if operations happen within same second
    - Tests initially used 0.01s sleep which was insufficient for second-precision IDs - needed 1.1s to guarantee different seconds
    - Org timestamps in STARTED property only show minute precision [YYYY-MM-DD DDD HH:MM], not seconds
    - This means two entries created in same minute have identical STARTED timestamps even though IDs differ
    - Tests must verify ID uniqueness rather than STARTED timestamp uniqueness
    - File buffer caching caused stale data reads - =doing--parse-file= reads from disk but if buffer exists, later operations may use cached buffer
    - Solution: kill file buffers before operations that need fresh data with =when-let ((buf (get-file-buffer path))) (kill-buffer buf)=
    - =find-file-noselect= can trigger interactive "File changed on disk" prompts in batch mode tests
    - Using =cl-letf= to override =yes-or-no-p= with =(lambda (_) t)= suppresses these prompts automatically

* 2026-01-24 - Daily rollover — today to week
- what was implemented
  - Created doing-rollover.el with =doing--rollover-daily= function for automatic entry migration
  - Function moves entries from today.org to week.org when they're from previous days
  - Uses date comparison via =doing--timestamp-date= to identify old entries
  - Preserves all entry properties (id, title, tags, started, ended, project) during migration
  - Returns count of moved entries for visibility, nil if nothing moved
  - Added comprehensive tests covering all rollover scenarios
  - All 67 tests pass successfully (63 from previous phases + 4 new tests)
- files changed
  - doing-rollover.el — new feature file with daily rollover functionality
  - doing.el — added =(require 'doing-rollover)= to load the new module
  - tests/doing-test.el — added =(require 'doing-rollover)= and Phase 14 with 4 new tests:
    - doing-test-rollover-daily-moves-old — validates old entries moved to week.org
    - doing-test-rollover-daily-keeps-today — verifies today's entries remain in today.org
    - doing-test-rollover-daily-no-entries — tests graceful handling of empty file
    - doing-test-rollover-daily-preserves-properties — ensures all entry properties survive migration
- learnings
  - patterns discovered
    - Rollover is implemented as a pure function that filters, copies, then deletes
    - Using =seq-filter= with predicate to separate old vs new entries based on date
    - =doing--timestamp-date= extracts YYYY-MM-DD for date comparison with =string-prefix-p=
    - Three-step process: parse entries, append to destination, delete from source
    - Returning count of moved entries provides useful feedback for callers
    - Buffer killing pattern (=kill-buffer (get-file-buffer path)=) is essential in tests to force fresh disk reads
    - Tests use =format-time-string= with =time-subtract= and =days-to-time= to generate yesterday's date dynamically
    - All entry properties (tags, project, ended, etc.) automatically preserved by =doing--append-entry-to-file=
  - gotchas encountered
    - Initial test failure: comparing full timestamp =[2026-01-23 Thu 10:00]= with date string ="2026-01-23"= using =string-prefix-p= failed
    - Solution: use =doing--timestamp-date= to extract date portion before comparison
    - Must kill buffers before and after rollover in tests to ensure file system state is accurate
    - =doing--delete-entry= generates "Cut: Subtree(s)" messages in test output which is expected org behavior
    - Week.org file created automatically by =doing--ensure-file= when first entry appended
    - Rollover returns nil (not 0) when no entries need moving - important for conditional logic
    - Date filtering uses =not (string-prefix-p today ...)= to identify old entries, cleaner than >= comparison
* 2026-01-24 - Weekly rollover — week to archive
- what was implemented
  - Added doing--rollover-weekly function to doing-rollover.el for automatic archive migration
  - Function moves entries from week.org to archive/YYYY-WNN.org when they're from previous ISO weeks
  - Uses ISO week comparison via doing--iso-week to identify old entries
  - Preserves all entry properties (id, title, tags, started, ended, project) during archival
  - Returns count of moved entries for visibility, nil if nothing moved
  - Each entry is archived to its corresponding week file (e.g., 2026-W03.org, 2026-W04.org)
  - Added 5 comprehensive tests covering all rollover scenarios
  - All 72 tests pass successfully (67 from previous phases + 5 new tests)
- files changed
  - doing-rollover.el — added doing--rollover-weekly function implementing weekly archive logic
  - tests/doing-test.el — added Phase 15 with 5 new tests:
    - doing-test-rollover-weekly-archives — validates old entries moved to correct archive files
    - doing-test-rollover-weekly-correct-filename — verifies YYYY-WNN.org filename format with zero-padding
    - doing-test-rollover-weekly-no-old-entries — tests graceful handling when only current week entries exist
    - doing-test-rollover-weekly-preserves-properties — ensures all entry properties survive archival
    - doing-test-rollover-weekly-multiple-weeks — tests entries from multiple past weeks go to separate archive files
- learnings
  - patterns discovered
    - Weekly rollover follows same pattern as daily rollover: filter by week, copy to archive, delete from source
    - Using doing--iso-week with time parameter to determine which week an entry belongs to
    - encode-time converts parsed timestamp (from org-parse-time-string) to time value for doing--iso-week
    - Archive file path determined by entry's ISO week: doing--file-archive takes (year week) list
    - Counter pattern with setq: (setq moved (1+ moved)) tracks number of entries archived
    - Multiple archive files created automatically as needed, one per ISO week
    - Tests use time-subtract with days-to-time to generate past week timestamps dynamically
    - Buffer killing before and after operations ensures fresh file reads in tests
  - gotchas encountered
    - Initial compilation error: used let instead of let* for sequential variable bindings
    - Compilation warning "reference to free variable" when using let with dependent bindings
    - Solution: change all let to let* in tests where later bindings depend on earlier ones
    - Example: (let* ((time ...) (week (doing--iso-week time)))) not (let ((time ...) (week (doing--iso-week time))))
    - Must use encode-time to convert parsed time before passing to doing--iso-week
    - org-parse-time-string returns decoded time list, encode-time converts to time value
    - Entries from different weeks create separate archive files automatically
    - doing--file-archive with zero-padded week numbers ensures correct lexicographic sorting (2026-W01.org, not 2026-W1.org)
    - Rollover returns nil (not 0) when no entries moved, consistent with daily rollover behavior
    - org-cut-subtree messages "Cut: Subtree(s)" appear in test output which is expected org behavior

* 2026-01-24 - Integrate rollover into commands
- what was implemented
  - Added doing--ensure-rollover function to doing-rollover.el with throttling mechanism
  - Function checks if at least one hour (3600 seconds) has passed since last rollover
  - Uses defvar doing--last-rollover-time to track last rollover timestamp
  - Integrated rollover calls into doing-now and doing-current commands
  - Added require 'doing-rollover to both command files
  - Added 3 comprehensive tests for rollover integration
  - All 75 tests pass successfully (72 from previous phases + 3 new tests)
- files changed
  - doing-rollover.el — added doing--ensure-rollover function and doing--last-rollover-time variable
  - doing-now.el — added (require 'doing-rollover) and call to doing--ensure-rollover at start
  - doing-current.el — added (require 'doing-rollover) and call to doing--ensure-rollover at start
  - tests/doing-test.el — added Phase 16 with 3 new tests:
    - doing-test-ensure-rollover-throttled — tests throttling with time-subtract and seconds-to-time
    - doing-test-ensure-rollover-called-by-commands — tests commands call rollover using cl-letf mocking
    - doing-test-rollover-with-old-data — tests end-to-end rollover with yesterday's entry
- learnings
  - patterns discovered
    - Throttling pattern: check if variable is nil OR time difference exceeds threshold
    - Using float-time with time-subtract to compute elapsed seconds: (float-time (time-subtract now then))
    - seconds-to-time converts integer seconds to time value for arithmetic: (seconds-to-time 7200)
    - time-subtract works in reverse: (time-subtract (current-time) (seconds-to-time 7200)) gives 2 hours ago
    - Mocking functions in tests with cl-letf: (cl-letf (((symbol-function 'foo) (lambda () ...))) ...)
    - Lazy rollover approach: only call rollover from user-facing commands, not internal utilities
    - Testing throttling requires manipulating the timestamp variable directly to simulate time passing
    - Using 3600 seconds (1 hour) as throttle interval balances responsiveness with performance
  - gotchas encountered
    - Must add (require 'doing-rollover) to any file that calls doing--ensure-rollover
    - defvar creates a global variable that persists across function calls (needed for throttling)
    - Tests must set doing--last-rollover-time to nil to ensure clean state
    - Cannot actually sleep for an hour in tests, must simulate time passage with setq
    - time-subtract returns a time value, not seconds - must use float-time to get numeric value
    - equal vs eq: time values must use equal for comparison, not eq
    - cl-letf requires lambda form with underscore for ignored arguments: (lambda (_) ...)
    - Mocked functions replace the symbol-function, not the variable binding
    - Buffer management still critical: must kill buffers between operations in rollover tests
    - Rollover affects file system state, so tests need proper cleanup with unwind-protect
