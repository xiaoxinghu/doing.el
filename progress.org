#+title: doing.el Development Progress

* 2026-01-23 - Package skeleton and configuration
- what was implemented
  - Main package file (doing.el) with proper headers
  - Package metadata: author, version, dependencies (emacs 27.1, org 9.0)
  - Customization group =doing= under =org= group
  - User-facing customization: =doing-directory= (default ~/org/doing/)
  - Internal configuration constants for file names (today.org, week.org, archive/)
- files changed
  - doing.el — complete rewrite with proper package structure
  - tests/doing-test.el — new tests for customization group and config
- learnings
  - patterns discovered
    - Use =defconst= for internal configuration that shouldn't change
    - Keep internal config separate from user customization (=defcustom= vs =defconst=)
    - Testing for customization group via =(get 'symbol 'custom-group)=
  - gotchas encountered
    - Need to use =expand-file-name= in default value for =doing-directory= to ensure absolute path
    - Package-Requires uses parenthesized list format: =((emacs "27.1") (org "9.0"))=

* 2026-01-23 - File and directory utilities
- what was implemented
  - Created doing-lib.el with core file/directory utilities
  - =doing--directory ()= — creates and returns the doing directory with archive subdirectory
  - =doing--file-today ()= — returns full path to today.org
  - =doing--file-week ()= — returns full path to week.org
  - =doing--file-archive (year week)= — returns path to archive/YYYY-WNN.org with zero-padded week numbers
  - =doing--ensure-directory ()= — ensures directory structure exists
  - =doing--ensure-file (path &optional title)= — creates file with Org header if missing
  - Added comprehensive tests covering all utilities
  - Updated doing.el and doing-test.el to require doing-lib
- files changed
  - doing-lib.el — new file with internal utilities (double-hyphen prefix for internal functions)
  - tests/doing-test.el — added 4 new tests for file/directory operations
  - doing.el — added =(require 'doing-lib)=
- learnings
  - patterns discovered
    - Using =make-directory= with =t= argument creates parent directories automatically
    - Combining =file-name-sans-extension= and =file-name-nondirectory= to derive titles from filenames
    - =doing--directory= creates both main and archive dirs in one call for convenience
    - Testing with temporary directories using =make-temp-file= with =t= flag and =unwind-protect= for cleanup
    - =write-region= is the standard way to create new files from a temp buffer
  - gotchas encountered
    - Archive file path format uses =%04d= and =%02d= to ensure proper zero-padding (2026-W01, not 2026-W1)
    - =doing--ensure-directory= is a thin wrapper that just calls =doing--directory= since that already creates directories
    - Must call =expand-file-name= in all path functions to ensure absolute paths
    - Tests need to verify both file existence AND that files are directories with =file-directory-p=

* 2026-01-23 - Timestamp and duration utilities
- what was implemented
  - Added timestamp and duration utilities to doing-lib.el
  - =doing--timestamp-now ()= — returns current time as Org inactive timestamp [YYYY-MM-DD DDD HH:MM]
  - =doing--timestamp-to-time (timestamp)= — parses Org timestamp string to Emacs time structure
  - =doing--timestamp-date (timestamp)= — extracts YYYY-MM-DD from timestamp string
  - =doing--duration-minutes (start-ts end-ts)= — computes elapsed minutes between two timestamps
  - =doing--duration-format (minutes)= — formats minutes as H:MM string using =org-duration-from-minutes=
  - =doing--iso-week (&optional time)= — returns (YEAR WEEK) list for given time or now
  - =doing--iso-week-string (&optional time)= — returns YYYY-WNN string for archive file naming
  - Added 7 comprehensive tests covering all timestamp/duration functionality
  - All 15 tests pass successfully
- files changed
  - doing-lib.el — added timestamp and duration utility functions
  - tests/doing-test.el — added 7 new tests (doing-test-timestamp-now-format, doing-test-timestamp-date-extraction, doing-test-duration-calculation, doing-test-duration-format, doing-test-iso-week-string, doing-test-iso-week, doing-test-timestamp-to-time)
- learnings
  - patterns discovered
    - =format-time-string= with =%G= gives ISO year, =%V= gives ISO week number (zero-padded)
    - =org-parse-time-string= converts Org timestamps to decoded time lists (9 elements)
    - =encode-time= converts decoded time back to internal time representation
    - =time-subtract= and =float-time= are used together to compute elapsed seconds
    - =org-duration-from-minutes= handles duration formatting automatically, respecting =org-duration-format=
    - ISO 8601 week numbers can differ from calendar year (e.g., early January might be week 52/53 of previous year)
    - Using =encode-time= in tests with explicit values (sec min hour day month year) creates reproducible test fixtures
  - gotchas encountered
    - Org inactive timestamps use brackets =[...]= not angle brackets =<...>=
    - =org-parse-time-string= returns a 9-element list: (SEC MIN HOUR DAY MON YEAR DOW DST TZ)
    - ISO week calculation requires =%G= (ISO year) not =%Y= (calendar year) to handle year boundaries correctly
    - =time-subtract= expects both arguments to be time values (not decoded time), so must call =encode-time= first
    - Duration formatting behavior depends on =org-duration-format= customization, so tests check for presence of digits rather than exact format
    - Week numbers are 1-indexed and can go up to 53 in some years (ISO 8601 long years)

* 2026-01-23 - Entry parsing with org-element
- what was implemented
  - Added entry parsing utilities to doing-lib.el using org-element API
  - =doing--parse-entry-at-point ()= — parses headline at point into entry plist with :id, :title, :tags, :started, :ended, :project, :begin, :end
  - =doing--parse-buffer ()= — returns list of all entries in current buffer by parsing with org-element-parse-buffer
  - =doing--parse-file (path)= — returns list of entries from file at PATH, using temp buffer to avoid interfering with user's buffers
  - Added 3 comprehensive tests covering single entry parsing, multiple entry parsing, and file parsing
  - All 18 tests pass successfully (15 from previous phases + 3 new tests)
- files changed
  - doing-lib.el — added entry parsing section with three parsing functions
  - tests/doing-test.el — added 3 new tests (doing-test-parse-entry-at-point, doing-test-parse-buffer-multiple, doing-test-parse-file)
- learnings
  - patterns discovered
    - =org-element-at-point= returns parsed element at cursor position; check type with =org-element-type=
    - =org-element-parse-buffer= with ='headline= granularity is fast and efficient for parsing entire buffers
    - =org-element-map= with lambda function is the idiomatic way to traverse and extract data from parsed AST
    - Properties from drawer are available via =org-element-property= with uppercase keyword symbols (e.g., =:ID=, =:STARTED=, =:PROJECT=)
    - =:raw-value= property contains the headline text without tags
    - =:tags= property returns a list of tag strings, or nil if no tags
    - =:begin= and =:end= properties give buffer positions for the entry
    - Using =with-temp-buffer= + =insert-file-contents= + =org-mode= is the pattern for parsing files without side effects
    - Test files need proper Org structure with #+TITLE and blank lines between entries
  - gotchas encountered
    - Must call =org-mode= in temp buffer after inserting file contents, otherwise org-element functions won't work properly
    - =org-element-at-point= returns nil (not an error) when point is not at a headline, so must check with =when=
    - Property values are stored as strings in the element plist, including timestamps
    - Tags are returned as a list, not a string, and empty tag lists are nil (not empty list)
    - =find-file-noselect= opens buffers which remain open after tests, while =with-temp-buffer= cleans up automatically
    - Tests creating multiple test files in same temp directory need unique filenames to avoid conflicts

* 2026-01-23 - Entry serialization — plist to Org
- what was implemented
  - Added entry serialization utilities to doing-lib.el
  - =doing--entry-to-org (entry)= — converts entry plist to Org headline string with properties drawer
    - Handles title, tags, id, started, ended, project, and body fields
    - Automatically computes and includes DURATION property when entry is finished (has :ended)
    - Tags are formatted as :tag1:tag2: on headline
    - Body text is appended after properties drawer
  - =doing--append-entry-to-file (entry path)= — appends formatted entry to file
    - Creates file with Org header if it doesn't exist (uses doing--ensure-file)
    - Uses temp buffer and append-to-file for safe appending
  - Added 7 comprehensive tests covering all serialization scenarios
  - All 25 tests pass successfully (18 from previous phases + 7 new tests)
- files changed
  - doing-lib.el — added Entry Serialization Utilities section with doing--entry-to-org and doing--append-entry-to-file
  - tests/doing-test.el — added Phase 5 with 7 new tests (doing-test-entry-to-org-minimal, doing-test-entry-to-org-with-tags, doing-test-entry-to-org-finished, doing-test-entry-to-org-with-project, doing-test-entry-to-org-with-body, doing-test-append-entry-to-file, doing-test-entry-to-org-complete)
- learnings
  - patterns discovered
    - Using =concat= with =when= conditionals to build up Org text incrementally makes code readable
    - =mapconcat #'identity tags ":"= is the idiomatic way to join tag lists into Org tag format :tag1:tag2:
    - =append-to-file= safely appends content to existing files without reading entire file into memory
    - Duration calculation is embedded in serialization: when an entry has :ended, compute duration on the fly using doing--duration-minutes and doing--duration-format
    - Property drawer format requires specific spacing: ":PROPERTY:  value" with multiple spaces for alignment
    - Body text should be appended after :END: with a newline to separate it from properties
    - Testing serialization requires checking for pattern matches (string-match-p) rather than exact strings, since duration formatting can vary
  - gotchas encountered
    - Must use =when= to conditionally include optional properties (ended, project, body) or empty plists will generate "nil" strings
    - Tags list can be nil (no tags) or a list of strings - must check with =when tags= before formatting
    - Duration is computed from start/end timestamps every time entry is serialized, not stored in the plist (it's derived data)
    - =append-to-file= requires temp buffer pattern: insert into temp buffer first, then append (point-min) (point-max) to file
    - File must exist before appending, so always call =doing--ensure-file= first to handle the case of new files
    - Format string alignment in properties drawer uses multiple spaces (":ID:       value") for visual consistency, matching Org-mode conventions
    - Body text should include trailing newline when present to ensure proper spacing between entries

* 2026-01-23 - Entry modification using org-entry API
- what was implemented
  - Added entry modification utilities to doing-lib.el for editing and deleting entries
  - =doing--goto-entry (id &optional file)= — navigates to entry by ID within a buffer
    - Searches for =:ID:= property using regex to handle whitespace variations
    - Uses =org-back-to-heading= to position point at headline start
    - Returns point if found, nil otherwise
  - =doing--update-entry-property (id property value &optional file)= — updates entry properties
    - Uses =org-entry-put= to modify properties without manual text manipulation
    - Automatically saves buffer after update
    - Returns t on success, nil if entry not found
  - =doing--delete-entry (id &optional file)= — removes entire entry
    - Uses =org-cut-subtree= to delete entry and all its content
    - Automatically saves buffer after deletion
    - Returns t on success, nil if entry not found
  - Added 5 comprehensive tests covering all modification scenarios
  - All 30 tests pass successfully (25 from previous phases + 5 new tests)
- files changed
  - doing-lib.el — added Entry Modification Utilities section with three new functions
  - tests/doing-test.el — added Phase 6 with 5 new tests:
    - doing-test-goto-entry — tests finding entries by ID and position handling
    - doing-test-update-property — tests property updates with org-entry-put
    - doing-test-delete-entry — tests entry deletion with org-cut-subtree
    - doing-test-goto-entry-with-whitespace — tests robustness to property drawer formatting
    - doing-test-update-property-multiple — tests updating multiple properties on same entry
- learnings
  - patterns discovered
    - =doing--goto-entry= must be called within the buffer context (uses point implicitly)
    - =org-entry-put= with =nil= as first argument operates on entry at point
    - =org-cut-subtree= removes entire subtree including body and nested headings
    - =org-back-to-heading= reliably positions point at headline start after property search
    - Using =save-excursion= in wrapper functions allows goto-entry to modify point without affecting caller
    - Regular expression =^[ \t]*:ID:[ \t]+%s[ \t]*$= handles various whitespace styles in property drawers
    - =find-file-noselect= opens file buffer without displaying it, useful for programmatic access
    - Tests should use =save-excursion= when calling functions that move point to avoid test interference
  - gotchas encountered
    - Initial implementation wrapped =doing--goto-entry= in =save-excursion=, but it needs to actually move point for =org-entry-put= and =org-cut-subtree= to work
    - =doing--goto-entry= cannot determine buffer context itself - caller must ensure correct buffer is current
    - Tests calling =doing--goto-entry= directly need to establish buffer context with =with-current-buffer=
    - Property drawer whitespace is inconsistent (tabs vs spaces), so regex must be flexible: =[ \t]+= not just spaces
    - =org-cut-subtree= shows "Cut: Subtree(s)" messages even in batch mode - this is normal org behavior
    - Must call =org-mode= on buffers created from file contents or org-element functions won't work properly
    - =org-entry-get= returns =nil= (not empty string) for missing properties, must use =(string= value ...)= in tests

* 2026-01-23 - Generate entry ID
- what was implemented
  - Added =doing--generate-id ()= function to doing-lib.el
  - Function generates timestamp-based unique IDs in format YYYYMMDDTHHMMSS
  - Returns a 15-character string using =format-time-string= with pattern "%Y%m%dT%H%M%S"
  - Added comprehensive tests for ID generation with 2 test cases
  - All 32 tests pass successfully (30 from previous phases + 2 new tests)
- files changed
  - doing-lib.el — added Entry ID Generation section with =doing--generate-id= function
  - tests/doing-test.el — added Phase 7 with 2 new tests:
    - doing-test-generate-id-format — validates ID format (15 chars, YYYYMMDDTHHMMSS pattern, reasonable values for year/month/day/hour/minute/second)
    - doing-test-generate-id-uniqueness — basic uniqueness test with sleep-for delay
- learnings
  - patterns discovered
    - =format-time-string= with "%Y%m%dT%H%M%S" produces compact timestamp-based IDs without special characters
    - Timestamp-based IDs are simple, sortable chronologically, and unique enough for single-user activity logging
    - Test can validate all components of timestamp ID by substring extraction and range checking
    - Using =sleep-for= with small delay (0.01s) in tests to ensure different timestamps for uniqueness testing
    - ID format follows ISO 8601 basic format (no dashes/colons) making it safe for property values
  - gotchas encountered
    - Uniqueness test is probabilistic - two IDs generated in same second would be identical, but acceptable for our use case
    - Test validates ID components (year, month, day, etc.) have reasonable ranges rather than exact values
    - No need for complex UUID libraries or =org-id= integration - simple timestamp is sufficient
    - Format string "%Y%m%dT%H%M%S" differs from display timestamps which use brackets and separators

* 2026-01-23 - doing-now — basic capture
- what was implemented
  - Created doing-now.el with the =doing-now= command for starting new activities
  - =doing-now= function takes a title and optional tags, creates entry in today.org
  - Entry includes auto-generated ID, title, tags (if provided), and STARTED timestamp
  - Command is interactive, prompting user for "What are you doing?"
  - Message confirms when activity is started
  - Added 3 comprehensive tests for doing-now functionality
  - All 35 tests pass successfully (32 from previous phases + 3 new tests)
  - Package compiles cleanly without warnings after adding forward declarations
- files changed
  - doing-now.el — new feature file with =doing-now= command (follows project structure guidelines)
  - doing.el — added =(require 'doing-now)= to load the new module
  - doing-lib.el — added forward declarations for variables from doing.el, added =(require 'org-element)=
  - tests/doing-test.el — added Phase 8 with 3 new tests:
    - doing-test-now-creates-entry — tests entry creation, multiple entries, ID/timestamp format validation
    - doing-test-now-without-tags — tests that command works without tags argument
    - doing-test-now-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Following CLAUDE.md guidelines for file organization: feature files named =doing-<feature>.el=
    - =doing-now.el= contains only the capture-related functionality, keeping code modular
    - Using =;;;###autoload= cookie on user-facing commands for proper autoloading
    - Interactive prompt string "sWhat are you doing? " where "s" means string input
    - =doing--ensure-directory= is called before file operations to guarantee directory exists
    - =doing--append-entry-to-file= handles both file creation and appending in one call
    - Forward declarations with =defvar= allow library files to reference variables from main package
    - =(require 'org-element)= needed in doing-lib.el to avoid compilation warnings about org-element functions
    - Test structure validates all entry components: title, tags, ID format, timestamp format, finished status
    - =(commandp 'doing-now)= is the proper way to test if function is interactive
  - gotchas encountered
    - Initial compilation showed warnings about free variables - resolved with forward declarations
    - Compilation warnings also appeared for org-element functions - resolved by adding =(require 'org-element)=
    - Must use =defvar= not =defcustom= in forward declarations or it creates duplicate definitions
    - Tests must use temporary directories to avoid interfering with user's actual doing directory
    - =doing-now= message output appears in test results ("Started: Write tests") which is expected behavior
    - File compilation order matters: doing.el must be compiled before doing-now.el since it defines the variables

* 2026-01-23 - doing-current — show current activity
- what was implemented
  - Created doing-current.el with the =doing-current= command for displaying current unfinished activity
  - =doing--current-entry= helper function finds the most recent unfinished entry from today.org
  - =doing-current= command displays current activity with elapsed time in minibuffer
  - Command is interactive, showing elapsed time in format [H:MM] followed by activity title
  - Handles case when no activity is in progress with appropriate message
  - Added 4 comprehensive tests for doing-current functionality
  - All 39 tests pass successfully (35 from previous phases + 4 new tests)
  - Package compiles cleanly without warnings
- files changed
  - doing-current.el — new feature file with =doing-current= and =doing--current-entry= (follows project structure guidelines)
  - doing.el — added =(require 'doing-current)= to load the new module
  - tests/doing-test.el — added Phase 9 with 4 new tests:
    - doing-test-current-shows-active — tests display of active entry with elapsed time, multiple entries
    - doing-test-current-when-nothing-active — tests "No activity in progress" message
    - doing-test-current-entry-helper — tests internal helper function behavior with various entry states
    - doing-test-current-is-interactive — verifies command has interactive declaration
- learnings
  - patterns discovered
    - Using =seq-find= with =reverse= to get most recent entry first is elegant and readable
    - Testing message output requires capturing from *Messages* buffer with =point-max= positioning
    - =if-let= provides clean conditional binding for nil-safe entry access
    - Helper function =doing--current-entry= provides good separation between logic and presentation
    - Computing elapsed time for current (unfinished) activity uses current time as end timestamp
    - Multiple tests for same feature can validate different aspects: display, error handling, helper functions
    - Following established pattern: feature file named =doing-current.el=, helper functions use =doing--= prefix
  - gotchas encountered
    - Message buffer testing is tricky - must get =point-max= before calling function and read after
    - =if-let= requires entry to be non-nil; when nil, falls through to else clause correctly
    - =doing--current-entry= intentionally returns nil when no unfinished entries exist, not an error
    - =reverse= is necessary because =doing--parse-file= returns entries in file order (oldest first)
    - Tests create finished entries by manually setting :ended property, simulating real workflow
    - Message output appears in test results which is expected and not a problem
